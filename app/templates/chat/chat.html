{% extends "base.html" %}

{% block title %}å¯¹è¯ - AI-RPA-Chat{% endblock %}

{% block content %}
<div class="row">
    <!-- æ™ºèƒ½ä½“é€‰æ‹©ä¾§è¾¹æ  -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                é€‰æ‹©æ™ºèƒ½ä½“
            </div>
            <div class="card-body">
                <div class="list-group" id="agentList">
                    <!-- æ™ºèƒ½ä½“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
                <button class="btn btn-primary mt-3 w-100" onclick="location.href='{{ url_for('agent.agent_page') }}'">
                    <i class="fas fa-cog"></i> ç®¡ç†æ™ºèƒ½ä½“
                </button>
            </div>
        </div>
    </div>

    <!-- èŠå¤©ä¸»ç•Œé¢ -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    å¯¹è¯ 
                    <span id="currentAgent" class="badge bg-primary ms-2">æœªé€‰æ‹©æ™ºèƒ½ä½“</span>
                </div>
                <div id="typingIndicator" class="text-muted" style="display: none;">
                    <small><i class="fas fa-circle-notch fa-spin"></i> AIæ­£åœ¨æ€è€ƒ...</small>
                </div>
            </div>
            <div class="card-body">
                <div class="chat-container" id="chatMessages">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="message bot-message text-center welcome-message">
                        ğŸ‘‹ è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“å¼€å§‹å¯¹è¯
                    </div>
                </div>
                <div class="mt-3">
                    <form id="messageForm" class="d-flex gap-2">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i> å‘é€
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="clearChat()">
                            <i class="fas fa-trash"></i> æ¸…ç©º
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- åœ¨ base.html ä¸­æ·»åŠ  Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<script>
let currentAgentId = localStorage.getItem('currentAgentId');
let currentAgentName = localStorage.getItem('currentAgentName');
let chatHistory = [];
let isProcessing = false;

// åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨
async function loadAgents() {
    try {
        const response = await fetch('{{ url_for("agent.list_agents") }}');
        const agents = await response.json();
        const agentList = document.getElementById('agentList');
        agentList.innerHTML = agents.map(agent => `
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
               onclick="selectAgent(${agent.id}, '${agent.name}')"
               data-agent-id="${agent.id}">
                <div>
                    <div class="fw-bold">${agent.name}</div>
                    <small class="text-muted">${agent.model_name || 'é»˜è®¤æ¨¡å‹'}</small>
                </div>
                <span class="badge bg-primary rounded-pill" style="display: none;">
                    <i class="fas fa-check"></i>
                </span>
            </a>
        `).join('');

        // å¦‚æœæœ‰ä¿å­˜çš„æ™ºèƒ½ä½“IDï¼Œè‡ªåŠ¨é€‰æ‹©è¯¥æ™ºèƒ½ä½“
        if (currentAgentId && currentAgentName) {
            // ç¡®ä¿æ™ºèƒ½ä½“å­˜åœ¨äºåˆ—è¡¨ä¸­
            const agentExists = agents.some(agent => agent.id == currentAgentId);
            if (agentExists) {
                updateAgentSelection(currentAgentId, currentAgentName);
                await loadChatHistory(currentAgentId);
            } else {
                // å¦‚æœæ™ºèƒ½ä½“ä¸å­˜åœ¨ï¼Œæ¸…é™¤localStorage
                localStorage.removeItem('currentAgentId');
                localStorage.removeItem('currentAgentName');
                currentAgentId = null;
                currentAgentName = null;
                document.getElementById('currentAgent').textContent = 'æœªé€‰æ‹©æ™ºèƒ½ä½“';
            }
        }
    } catch (error) {
        console.error('åŠ è½½æ™ºèƒ½ä½“å¤±è´¥:', error);
        showError('åŠ è½½æ™ºèƒ½ä½“å¤±è´¥');
    }
}

// æ›´æ–°æ™ºèƒ½ä½“é€‰æ‹©çŠ¶æ€
function updateAgentSelection(agentId, agentName) {
    document.querySelectorAll('#agentList .list-group-item').forEach(item => {
        const badge = item.querySelector('.badge');
        if (item.dataset.agentId == agentId) {
            item.classList.add('active');
            badge.style.display = 'inline-block';
        } else {
            item.classList.remove('active');
            badge.style.display = 'none';
        }
    });

    document.getElementById('currentAgent').textContent = agentName;
    
    // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
    const welcomeMessage = document.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
}

// æ˜¾ç¤ºé”™è¯¯æç¤º
function showError(message) {
    const toast = `
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast" role="alert">
                <div class="toast-header bg-danger text-white">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong class="me-auto">é”™è¯¯</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', toast);
    const toastEl = document.querySelector('.toast:last-child');
    const toast_instance = new bootstrap.Toast(toastEl);
    toast_instance.show();
}

// æ¸…ç©ºèŠå¤©
function clearChat() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ')) {
        return;
    }
    chatHistory = [];
    displayMessages([]);
}

// åŠ è½½èŠå¤©å†å²
async function loadChatHistory(agentId) {
    try {
        const response = await fetch(`{{ url_for("chat.get_history") }}?agent_id=${agentId}`);
        const history = await response.json();
        displayMessages(history.messages || []);
    } catch (error) {
        console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
        showError('åŠ è½½èŠå¤©å†å²å¤±è´¥');
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function displayMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    if (messages.length > 0) {
        chatHistory = chatHistory.concat(messages);
    }
    
    chatMessages.innerHTML = chatHistory.map(msg => `
        <div class="message ${msg.role === 'user' ? 'user-message' : 'bot-message'}">
            ${msg.role === 'user' ? '<i class="fas fa-user me-2"></i>' : '<i class="fas fa-robot me-2"></i>'}
            ${msg.content}
        </div>
    `).join('');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// é€‰æ‹©æ™ºèƒ½ä½“
async function selectAgent(agentId, agentName) {
    currentAgentId = agentId;
    currentAgentName = agentName;
    
    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('currentAgentId', agentId);
    localStorage.setItem('currentAgentName', agentName);
    
    updateAgentSelection(agentId, agentName);
    chatHistory = [];
    await loadChatHistory(agentId);
}

// è®¾ç½®å‘é€çŠ¶æ€
function setProcessingState(processing) {
    isProcessing = processing;
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const messageInput = document.getElementById('messageInput');
    
    sendButton.disabled = processing;
    messageInput.disabled = processing;
    typingIndicator.style.display = processing ? 'block' : 'none';
}

// å‘é€æ¶ˆæ¯
document.getElementById('messageForm').onsubmit = async (e) => {
    e.preventDefault();
    if (isProcessing) return;
    
    if (!currentAgentId) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“');
        return;
    }

    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;

    try {
        setProcessingState(true);
        const response = await fetch('{{ url_for("chat.send_message") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                agent_id: currentAgentId,
                messages: chatHistory.concat([{
                    role: 'user',
                    content: message
                }])
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        displayMessages([
            { role: 'user', content: message },
            result
        ]);

        input.value = '';
    } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        showError(error.message);
    } finally {
        setProcessingState(false);
    }
};

// ç›‘å¬è¾“å…¥æ¡†å›è½¦äº‹ä»¶
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
    }
});

// é¡µé¢åŠ è½½æ—¶åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨
document.addEventListener('DOMContentLoaded', () => {
    loadAgents();
    
    // å¦‚æœæ²¡æœ‰é€‰æ‹©æ™ºèƒ½ä½“ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    if (!currentAgentId) {
        document.getElementById('currentAgent').textContent = 'æœªé€‰æ‹©æ™ºèƒ½ä½“';
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="message bot-message text-center welcome-message">
                ğŸ‘‹ è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“å¼€å§‹å¯¹è¯
            </div>
        `;
    }
});
</script>
{% endblock %} 